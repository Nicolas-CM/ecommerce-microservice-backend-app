name: CI-CD Stage - Full Validation & Deploy

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write
  issues: write

on:
  push:
    branches: [stage]
  pull_request:
    branches: [stage]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}
  SKIP_SONAR: 'true'
  SKIP_TRIVY: 'true'

jobs:
  # ============================================================================
  # OWASP ZAP SECURITY SCAN
  # ============================================================================
  security-tests:
    name: üîê OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    environment: stage
    needs: []
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: ‚öôÔ∏è Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: üåê Get API Gateway IP
        id: get-ip
        run: |
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc api-gateway -n ecommerce-stage -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ ! -z "$EXTERNAL_IP" ]; then
              echo "TARGET_URL=http://$EXTERNAL_IP:8080" >> $GITHUB_ENV
              echo "‚úÖ Target: http://$EXTERNAL_IP:8080"
              break
            fi
            sleep 10
          done

      - name: üîç Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: üì§ Upload ZAP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_html.html
            report_md.md
          retention-days: 7

  # ============================================================================
  # NOTIFY ON FAILURE
  # ============================================================================
  notify-failure:
    name: üìß Notify Failure
    runs-on: ubuntu-latest
    needs: [security-tests]
    if: failure()
    steps:
      - name: üìß Send Failure Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Stage Pipeline Failed - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions
          body: |
            Stage Pipeline Failed!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            Triggered by: ${{ github.actor }}
            
            Please check the logs for details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

name: CI-CD Stage - Full Validation & Deploy

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write

on:
  push:
    branches: [stage]
  pull_request:
    branches: [stage]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  # ============================================================================
  # BUILD & TEST CON SONARQUBE (como flamini)
  # ============================================================================
  maven-build:
    name: ğŸ”¨ Build & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§­ Normalize Image Owner (lowercase)
        run: |
          OWNER_LOWER=$(echo "$IMAGE_PREFIX" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LOWER=$OWNER_LOWER" >> $GITHUB_ENV
        env:
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}

      - name: ğŸ§­ Normalize Image Owner (lowercase)
        run: |
          OWNER_LOWER=$(echo "$IMAGE_PREFIX" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LOWER=$OWNER_LOWER" >> $GITHUB_ENV
        env:
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}

      - name: â˜• Set up JDK 11 and 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: |
            11
            17

      - name: ğŸ”¨ Build with Maven (unit tests)
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_11_X64 }}
        run: |
          echo "Building with Java 11"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          chmod +x ./mvnw
          ./mvnw -B -T 1C verify -Dtest="*ServiceImplTest" -DfailIfNoTests=false

      - name: ğŸ“Š SonarQube Analysis
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
        run: |
          # Check if secrets are set
          if [ -z "$SONAR_TOKEN" ] || [ -z "$SONAR_HOST_URL" ]; then
            echo "âš ï¸  SONAR_HOST_URL or SONAR_TOKEN not set; skipping SonarQube analysis"
            exit 0
          fi

          # Validate URL scheme
          if [[ ! "$SONAR_HOST_URL" =~ ^https?:// ]]; then
            echo "âš ï¸  SONAR_HOST_URL does not start with http:// or https://; skipping"
            echo "   Current value: '$SONAR_HOST_URL'"
            exit 0
          fi

          echo "â¡ï¸  Running SonarQube analysis against $SONAR_HOST_URL"
          echo "   JAVA_HOME: $JAVA_HOME"
          echo "   Java version: $(java -version 2>&1 | head -n 1)"
          
          chmod +x ./mvnw
          
          # Check if using SonarCloud (requires organization)
          if [[ "$SONAR_HOST_URL" == *"sonarcloud.io"* ]]; then
            echo "Using SonarCloud - organization parameter required"
            ./mvnw -B -DskipTests=true sonar:sonar \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN" \
              -Dsonar.organization="nicolas-cm" \
              -Dsonar.projectKey="Nicolas-CM_ecommerce-microservice-backend-app" \
              -Dsonar.projectName="ecommerce-microservice-backend-app" \
              -Dsonar.coverage.jacoco.xmlReportPaths="**/target/site/jacoco/jacoco.xml,**/target/site/jacoco-aggregate/jacoco.xml"
          else
            echo "Using self-hosted SonarQube"
            ./mvnw -B -DskipTests=true sonar:sonar \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN" \
              -Dsonar.projectKey="ecommerce-stage" \
              -Dsonar.projectName="ecommerce-stage" \
              -Dsonar.coverage.jacoco.xmlReportPaths="**/target/site/jacoco/jacoco.xml,**/target/site/jacoco-aggregate/jacoco.xml"
          fi

      - name: ğŸ“¤ Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
          retention-days: 3

      - name: ğŸ“¦ Upload build workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: |
            .
            !.git
          retention-days: 1

  # ============================================================================
  # TRIVY SECURITY SCAN
  # ============================================================================
  trivy-scan:
    name: ğŸ”’ Trivy Security Scan
    runs-on: ubuntu-latest
    needs: maven-build
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§­ Normalize Image Owner (lowercase)
        run: |
          OWNER_LOWER=$(echo "$IMAGE_PREFIX" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LOWER=$OWNER_LOWER" >> $GITHUB_ENV
        env:
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}

      - name: ğŸ” Run Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-repo-scan.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-repo-scan.sarif'

      - name: ğŸ“¦ Save Trivy Report as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-repo-scan
          path: trivy-repo-scan.sarif

  # ============================================================================
  # GENERATE VERSION TAG (stage-0.1.0-commit-timestamp)
  # ============================================================================
  calculate-semver:
    name: ğŸ“‹ Calculate Version
    runs-on: ubuntu-latest
    needs: [maven-build, trivy-scan]
    outputs:
      new_version: ${{ steps.generate.outputs.version }}
      image_tag: ${{ steps.generate.outputs.image_tag }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate Stage Version Tag
        id: generate
        run: |
          # Get latest stage tag or default to 0.0.0
          LATEST_TAG=$(git tag -l "stage-*" --sort=-version:refname | head -n1 || echo "stage-0.0.0")
          
          if [ "$LATEST_TAG" = "stage-0.0.0" ]; then
            BASE_VERSION="0.1.0"
          else
            # Extract version from tag (e.g., stage-0.1.0-abc123-20240115)
            BASE_VERSION=$(echo $LATEST_TAG | sed -E 's/stage-([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
            
            # Increment patch version
            MAJOR=$(echo $BASE_VERSION | cut -d. -f1)
            MINOR=$(echo $BASE_VERSION | cut -d. -f2)
            PATCH=$(echo $BASE_VERSION | cut -d. -f3)
            PATCH=$((PATCH + 1))
            BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          # Generate short commit sha (7 chars)
          if [ -n "${GITHUB_SHA:-}" ]; then
            COMMIT_SHA=$(echo ${GITHUB_SHA} | cut -c1-7)
          else
            COMMIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          fi
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          # Build tag format as requested: 0.1.0-stage.372d17b (no timestamp)
          IMAGE_TAG="${BASE_VERSION}-stage.${COMMIT_SHA}"
          FULL_VERSION="$IMAGE_TAG"

          # Validate BASE_VERSION format (x.y.z), fallback to 0.1.0 if invalid
          if ! echo "${BASE_VERSION}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null 2>&1; then
            echo "âš ï¸  BASE_VERSION format invalid: ${BASE_VERSION}, defaulting to 0.1.0"
            BASE_VERSION="0.1.0"
            IMAGE_TAG="${BASE_VERSION}-stage.${COMMIT_SHA}"
            FULL_VERSION="$IMAGE_TAG"
          fi

          # Sanitize IMAGE_TAG for Docker: lowercase, remove leading non-alphanum, replace invalid chars with '-'
          IMAGE_TAG_SANITIZED=$(echo "$IMAGE_TAG" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[^a-z0-9]+//g' | sed -E 's/[^a-z0-9._-]+/-/g' | sed -E 's/[-]{2,}/-/g' | sed -E 's/^[._-]+//g' | sed -E 's/[._-]+$//g')
          if [ -z "$IMAGE_TAG_SANITIZED" ]; then
            echo "âš ï¸  Generated image tag '$IMAGE_TAG' could not be sanitized. Defaulting to 0.1.0-unknown"
            IMAGE_TAG_SANITIZED="0.1.0-unknown-${TIMESTAMP}"
          fi
          IMAGE_TAG="$IMAGE_TAG_SANITIZED"

          # Sanitize FULL_VERSION for use as git tag
          FULL_VERSION_SANITIZED=$(echo "$FULL_VERSION" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]+/-/g' | sed -E 's/[-]{2,}/-/g' | sed -E 's/^[._-]+//g' | sed -E 's/[._-]+$//g')
          
          echo "Generated version: $FULL_VERSION => sanitized: $FULL_VERSION_SANITIZED"
          echo "Image tag: $IMAGE_TAG (sanitized: $IMAGE_TAG_SANITIZED)"
          
          # Export both values
          echo "image_tag=$IMAGE_TAG_SANITIZED" >> $GITHUB_OUTPUT
          echo "version=$FULL_VERSION_SANITIZED" >> $GITHUB_OUTPUT

  # ============================================================================
  # DOCKER BUILD & PUSH
  # ============================================================================
  docker-build:
    name: ğŸ³ Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [maven-build, calculate-semver]
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - cloud-config
          - service-discovery
          - proxy-client
          - user-service
          - product-service
          - order-service
          - payment-service
          - shipping-service
          - favourite-service
    steps:
      - name: ğŸ§­ Normalize Image Owner (lowercase)
        run: |
          # Normalize the OWNER (Image prefix) to lowercase so ghcr repo path is valid
          OWNER_LOWER=$(echo "$IMAGE_PREFIX" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LOWER=$OWNER_LOWER" >> $GITHUB_ENV
        env:
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
      - name: ğŸ“¥ Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace

      - name: ğŸ Debug - show computed tag values
        run: |
          echo "DEBUG: OWNER_LOWER=$OWNER_LOWER"
          echo "DEBUG: REGISTRY=$REGISTRY"
          echo "DEBUG: SERVICE=${{ matrix.service }}"
          echo "DEBUG: IMAGE_TAG=${{ needs.calculate-semver.outputs.image_tag }}"
          echo "DEBUG: NEW_VERSION=${{ needs.calculate-semver.outputs.new_version }}"

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and Push Docker Image
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE_TAG="${{ needs.calculate-semver.outputs.image_tag }}"
          # Validate image tag for Docker (must not start with invalid characters)
          if [[ -z "$IMAGE_TAG" ]]; then
            echo "âŒ IMAGE_TAG is empty - aborting"
            exit 1
          fi
          if [[ ! "$IMAGE_TAG" =~ ^[a-z0-9][a-z0-9._-]*$ ]]; then
            echo "âŒ Derived IMAGE_TAG '$IMAGE_TAG' is invalid for Docker tag format."
            echo "   Valid characters: lowercase letters, digits, ., _, - and must start with alphanumeric."
            echo "   Please check generate-semver step or the repository tags."
            exit 1
          fi
          FULL_IMAGE="${REGISTRY}/${OWNER_LOWER}/${SERVICE}:${IMAGE_TAG}"
          LATEST_IMAGE="${REGISTRY}/${OWNER_LOWER}/${SERVICE}:stage-latest"
          
          echo "Building $SERVICE with tag $IMAGE_TAG"
          echo "Full image: $FULL_IMAGE"
          
          cd $SERVICE
          docker build -t $FULL_IMAGE -t $LATEST_IMAGE .
          docker push $FULL_IMAGE
          docker push $LATEST_IMAGE
          
          echo "âœ… Pushed $FULL_IMAGE"
          echo "âœ… Pushed $LATEST_IMAGE"

      - name: ğŸ” Scan Docker Image with Trivy (CLI)
        env:
          SERVICE: ${{ matrix.service }}
          IMAGE_TAG: ${{ needs.calculate-semver.outputs.image_tag }}
        run: |
          # Install trivy
          sudo apt-get update && sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy
          FULL_IMAGE="${REGISTRY}/${OWNER_LOWER}/${SERVICE}:${IMAGE_TAG}"
          echo "Scanning image: $FULL_IMAGE"
          trivy image --exit-code 0 --format sarif --output trivy-${SERVICE}.sarif $FULL_IMAGE || echo "trivy returned non-zero exit code"

      - name: ğŸ“¤ Upload Image Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'

  # ============================================================================
  # DEPLOY TO AKS STAGE
  # ============================================================================
  kubernetes-deploy:
    name: ğŸš€ Deploy to AKS Stage
    runs-on: ubuntu-latest
    needs: [docker-build, calculate-semver]
    environment: stage
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: âš™ï¸ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: ğŸ”„ Update Deployments
        run: |
          IMAGE_TAG="${{ needs.calculate-semver.outputs.image_tag }}"
            REGISTRY="${{ env.REGISTRY }}/${OWNER_LOWER}"
          
          echo "Updating deployments with image tag: $IMAGE_TAG"
          
          # List of application services
          declare -a SERVICES=(
            "api-gateway"
            "cloud-config"
            "service-discovery"
            "proxy-client"
            "user-service"
            "product-service"
            "order-service"
            "payment-service"
            "shipping-service"
            "favourite-service"
          )
          
          for SERVICE in "${SERVICES[@]}"; do
            echo "Updating $SERVICE..."
            
            if kubectl get deployment ${SERVICE} -n stage 2>/dev/null; then
              kubectl set image deployment/${SERVICE} \
                ${SERVICE}=${REGISTRY}/${SERVICE}:${IMAGE_TAG} \
                -n stage
              echo "âœ… Updated $SERVICE"
            else
              echo "âš ï¸  Deployment $SERVICE not found, skipping..."
            fi
          done

      - name: â³ Wait for Rollouts
        run: |
          declare -a SERVICES=(
            "api-gateway"
            "cloud-config"
            "service-discovery"
            "proxy-client"
            "user-service"
            "product-service"
            "order-service"
            "payment-service"
            "shipping-service"
            "favourite-service"
          )
          
          FAILED_DEPLOYMENTS=()
          
          for SERVICE in "${SERVICES[@]}"; do
            if kubectl get deployment ${SERVICE} -n stage 2>/dev/null; then
              echo "â³ Waiting for $SERVICE rollout..."
              
              if kubectl rollout status deployment/${SERVICE} -n stage --timeout=10m; then
                echo "âœ… $SERVICE rolled out successfully"
              else
                echo "âŒ $SERVICE rollout failed"
                FAILED_DEPLOYMENTS+=("$SERVICE")
              fi
            fi
          done
          
          if [ ${#FAILED_DEPLOYMENTS[@]} -gt 0 ]; then
            echo "âŒ Failed deployments: ${FAILED_DEPLOYMENTS[@]}"
            exit 1
          fi
          
          echo "âœ… All deployments completed successfully"

      - name: ğŸ” Verify Services
        run: |
          echo "ğŸ“‹ Final Kubernetes State:"
          kubectl get deployments -n stage
          kubectl get pods -n stage -o wide
          kubectl get services -n stage

  # ============================================================================
  # E2E TESTS (Postman/Newman)
  # ============================================================================
  e2e-tests:
    name: ğŸ§ª E2E Tests
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy, calculate-semver]
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: âš™ï¸ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: ğŸŒ Get API Gateway IP
        id: get-ip
        run: |
          echo "Getting API Gateway External IP..."
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc api-gateway -n stage -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ ! -z "$EXTERNAL_IP" ]; then
              echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
              echo "âœ… API Gateway IP: $EXTERNAL_IP"
              break
            fi
            echo "â³ Waiting for IP... ($i/30)"
            sleep 10
          done
          
          if [ -z "$EXTERNAL_IP" ]; then
            echo "âŒ Failed to get External IP"
            exit 1
          fi

      - name: â³ Wait for Services Ready
        run: |
          echo "Waiting for services to be ready..."
          
          declare -a ENDPOINTS=(
            "http://$EXTERNAL_IP:8080/actuator/health"
            "http://$EXTERNAL_IP:8080/user-service/actuator/health"
            "http://$EXTERNAL_IP:8080/product-service/actuator/health"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            for i in {1..20}; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint" 2>/dev/null || echo "000")
              if [ "$STATUS" = "200" ]; then
                echo "âœ… $endpoint is ready"
                break
              fi
              echo "â³ Waiting for $endpoint... ($i/20)"
              sleep 5
            done
          done

      - name: ğŸ§ª Run E2E Tests
        run: |
          echo "Running E2E tests against http://$EXTERNAL_IP:8080"
          
          if [ ! -f "postman-collections/E2E Ecommerce Microservices Tests.postman_collection.json" ]; then
            echo "âš ï¸  Postman collection not found, skipping E2E tests"
            exit 0
          fi
          
          mkdir -p test-reports
          
          newman run "postman-collections/E2E Ecommerce Microservices Tests.postman_collection.json" \
            --env-var "baseUrl=http://$EXTERNAL_IP:8080" \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export "test-reports/e2e-report.html" \
            --delay-request 500 \
            --timeout-request 10000 || echo "âš ï¸  Some E2E tests failed"

      - name: ğŸ“¤ Upload E2E Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-reports/
          retention-days: 7

  # ============================================================================
  # PERFORMANCE TESTS (Locust)
  # ============================================================================
  performance-tests:
    name: ğŸ“Š Performance Tests
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy, calculate-semver]
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Locust
        run: |
          pip install -r tests/performance/requirements.txt

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: âš™ï¸ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: ğŸŒ Get API Gateway IP
        id: get-ip
        run: |
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc api-gateway -n stage -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ ! -z "$EXTERNAL_IP" ]; then
              echo "API_GATEWAY_URL=http://$EXTERNAL_IP:8080" >> $GITHUB_ENV
              echo "âœ… API Gateway: http://$EXTERNAL_IP:8080"
              break
            fi
            sleep 10
          done

      - name: ğŸš€ Run Locust Performance Tests
        run: |
          cd tests/performance
          locust -f locustfile.py \
            --host=$API_GATEWAY_URL \
            --users 10 \
            --spawn-rate 2 \
            --run-time 1m \
            --headless \
            --html=locust-report.html \
            --csv=locust-stats

      - name: ğŸ“¤ Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: tests/performance/locust-*
          retention-days: 7

  # ============================================================================
  # OWASP ZAP SECURITY SCAN
  # ============================================================================
  security-tests:
    name: ğŸ” OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy, calculate-semver]
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: âš™ï¸ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: ğŸŒ Get API Gateway IP
        id: get-ip
        run: |
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc api-gateway -n stage -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ ! -z "$EXTERNAL_IP" ]; then
              echo "TARGET_URL=http://$EXTERNAL_IP:8080" >> $GITHUB_ENV
              echo "âœ… Target: http://$EXTERNAL_IP:8080"
              break
            fi
            sleep 10
          done

      - name: ğŸ” Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: ğŸ“¤ Upload ZAP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_html.html
            report_md.md
          retention-days: 7

  # ============================================================================
  # CREATE GITHUB RELEASE
  # ============================================================================
  create-release:
    name: ğŸ“¦ Create Stage Release
    runs-on: ubuntu-latest
    needs: [calculate-semver, e2e-tests, performance-tests, security-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/stage' && success()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Create Git Tag
        run: |
          VERSION="${{ needs.calculate-semver.outputs.new_version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a $VERSION -m "Stage Release $VERSION"
          git push origin $VERSION
          
          echo "âœ… Created tag: $VERSION"

      - name: ğŸ“ Generate Release Notes
        id: notes
        run: |
          VERSION="${{ needs.calculate-semver.outputs.new_version }}"
          IMAGE_TAG="${{ needs.calculate-semver.outputs.image_tag }}"
          
          cat << EOF > release_notes.md
          # Stage Release $VERSION
          
          ## ğŸš€ Deployment Information
          - **Version**: \`$VERSION\`
          - **Image Tag**: \`$IMAGE_TAG\`
          - **Deployment Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Environment**: Stage
          
          ## âœ… Validation Summary
          - âœ… Unit tests passed
          - âœ… SonarQube analysis completed
          - âœ… Trivy security scan passed
          - âœ… Docker images built and pushed
          - âœ… Deployed to AKS Stage
          - âœ… E2E tests executed
          - âœ… Performance tests completed
          - âœ… OWASP ZAP security scan executed
          
          ## ğŸ“¦ Container Images
          All services available at:
          \`ghcr.io/$OWNER_LOWER/<service>:$IMAGE_TAG\`
          
          ## ğŸ”— Artifacts
          - [E2E Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Performance Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Security Scan Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.calculate-semver.outputs.new_version }}
          name: Stage ${{ needs.calculate-semver.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # NOTIFY ON FAILURE
  # ============================================================================
  notify-failure:
    name: ğŸ“§ Notify Failure
    runs-on: ubuntu-latest
    needs: [maven-build, trivy-scan, docker-build, kubernetes-deploy, e2e-tests, performance-tests, security-tests]
    if: failure()
    steps:
      - name: ğŸ“§ Send Failure Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ Stage Pipeline Failed - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions
          body: |
            Stage Pipeline Failed!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            Triggered by: ${{ github.actor }}
            
            Please check the logs for details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

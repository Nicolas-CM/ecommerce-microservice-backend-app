name: CI-CD Prod - Full Validation & Deploy

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write
  issues: write

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  request-approval:
    name: "üìß Request Production Approval"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'))
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: Get image tags for approval email
        id: imgtags
        run: |
          if [ -f ./k8s/helm/image-tags-prod.yaml ]; then
            tags=$(grep -E ':\s*"' ./k8s/helm/image-tags-prod.yaml | sed 's/^[[:space:]]*//')
            echo "image_tags=${tags//$'\n'/ | }" >> $GITHUB_OUTPUT
          else
            echo "image_tags=No image tags file found" >> $GITHUB_OUTPUT
          fi

      - name: Send approval email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Production deploy approval needed - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions
          body: |
            Production deployment is awaiting approval.

            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Workflow   : ${{ github.workflow }}
            Run        : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Microservice image tags for production:
            ${{ steps.imgtags.outputs.image_tags }}

            Please review the changes and approve or reject the deployment.


  kubernetes-deploy:
    name: "üöÄ Deploy to AKS Prod (Helm)"
    runs-on: ubuntu-latest
    environment:
      name: prod
    needs: request-approval
    if: (github.event_name == 'workflow_dispatch' || github.event_name == 'push') && (github.event_name != 'push' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: ‚öôÔ∏è Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: üõ° Ensure namespace and GHCR secret
        run: |
          kubectl create namespace prod --dry-run=client -o yaml | kubectl apply -f -

          kubectl delete secret ghcr-secret -n prod --ignore-not-found

          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.GHCR_USERNAME }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --namespace=prod


      - name: üöÄ Helm Deploy
        run: |
          echo "Deploying ecommerce app to production..."

          helm upgrade --install ecommerce-app ./k8s/helm/ecommerce-chart \
            --namespace prod \
            --values ./k8s/helm/ecommerce-chart/values.yaml \
            --values ./k8s/helm/values-prod.yaml \
            --values ./k8s/helm/image-tags-prod.yaml \
            --set global.environment=prod

      - name: üîç Post-deploy status
        run: |
          kubectl get pods -n prod
          kubectl get svc -n prod

  generate-release-notes-prod:
    name: "üìù Generate Production Release Notes"
    runs-on: ubuntu-latest
    needs:
      [kubernetes-deploy]
    if: success()
    outputs:
      release_version: ${{ steps.output_info.outputs.version }}
      changelog: ${{ steps.output_info.outputs.changelog }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîé Generate version and changelog
        id: output_info
        run: |
          # Generate version from date and short commit hash
          VERSION=$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
          echo "Generated version: $VERSION"
          
          # Get latest prod release tag to compare
          LATEST_PROD_TAG=$(git tag -l "prod-*" | sort -V | tail -n1)
          
          if [ -z "$LATEST_PROD_TAG" ]; then
            echo "No previous prod release found, using last 10 commits"
            CHANGELOG=$(git log -10 --pretty=format:"- %s (%h)" | sed 's/"/\\"/g')
          else
            echo "Comparing with $LATEST_PROD_TAG"
            CHANGELOG=$(git log ${LATEST_PROD_TAG}..HEAD --pretty=format:"- %s (%h)" | sed 's/"/\\"/g')
            
            # If no changes since last prod release, use recent commits
            if [ -z "$CHANGELOG" ]; then
              echo "No new commits since last prod release, using last 5 commits"
              CHANGELOG=$(git log -5 --pretty=format:"- %s (%h)" | sed 's/"/\\"/g')
            fi
          fi
          
          # Read image tags from prod file
          IMAGE_TAGS=""
          if [ -f ./k8s/helm/image-tags-prod.yaml ]; then
            IMAGE_TAGS=$(grep -E ':\s*"' ./k8s/helm/image-tags-prod.yaml | sed 's/^[[:space:]]*/  - /')
          fi
          
          # Build complete changelog
          FULL_CHANGELOG="## Production Release ${VERSION}

          ### Image Tags
          ${IMAGE_TAGS}

          ### Changes
          ${CHANGELOG}

          **Deployed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}"
          
          # Output values
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Save changelog to file to avoid delimiter issues
          echo "$FULL_CHANGELOG" > /tmp/changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üè∑Ô∏è Create GitHub Release (Production)
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: prod-${{ steps.output_info.outputs.version }}
          release_name: Production Release ${{ steps.output_info.outputs.version }}
          body: ${{ steps.output_info.outputs.changelog }}
          draft: false
          prerelease: false

      - name: üìù Prepare changelog file
        env:
          CHANGELOG_CONTENT: ${{ steps.output_info.outputs.changelog }}
          VERSION: ${{ steps.output_info.outputs.version }}
        run: |
          printf "%s\n" "$CHANGELOG_CONTENT" > "CHANGELOG-PROD-${VERSION}.md"

      - name: üì§ Upload production changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: prod-release-notes
          path: CHANGELOG-PROD-${{ steps.output_info.outputs.version }}.md
          retention-days: 30

  notify-success:
    name: "‚úÖ Notify Success"
    runs-on: ubuntu-latest
    needs:
      [generate-release-notes-prod, kubernetes-deploy]
    if: success()
    steps:
      - name: Send success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Production deployment succeeded - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions
          body: |
            Production deployment completed successfully.

            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Release    : prod-${{ needs.generate-release-notes-prod.outputs.release_version }}
            Workflow   : ${{ github.workflow }}
            Run        : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-failure:
    name: "‚ùå Notify Failure"
    runs-on: ubuntu-latest
    needs:
      [generate-release-notes-prod, kubernetes-deploy]
    if: failure()
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Production deployment failed - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions
          body: |
            Production deployment failed or was cancelled.

            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Workflow   : ${{ github.workflow }}
            Run        : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please review the logs for details.

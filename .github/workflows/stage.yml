name: STAGE - Full Tests & Deploy to Minikube

on:
  push:
    branches: [ stage ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & All Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ðŸ”¨ Build All Services
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests
      
      - name: ðŸ§ª Run Unit Tests
        run: ./mvnw test
      
      - name: ðŸ“Š Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: All Unit Tests
          path: '**/target/surefire-reports/*.xml'
          reporter: java-junit
          fail-on-error: false
      
      - name: ðŸ“¦ Upload JARs
        uses: actions/upload-artifact@v4
        with:
          name: microservices-jars
          path: |
            */target/*.jar
            !*/target/*-sources.jar
            !*/target/*-javadoc.jar
          retention-days: 7
  
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ“¥ Download JARs
        uses: actions/download-artifact@v4
        with:
          name: microservices-jars
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: ðŸ”¨ Build Docker Images
        run: |
          services="service-discovery cloud-config api-gateway proxy-client user-service product-service order-service payment-service shipping-service favourite-service"
          for service in $services; do
            echo "Building $service..."
            cd $service
            docker build -t $service:latest -t $service:${{ github.sha }} .
            cd ..
          done
      
      - name: ðŸ’¾ Save Docker Images
        run: |
          mkdir -p docker-images
          services="user-service product-service order-service"
          for service in $services; do
            docker save $service:latest > docker-images/$service.tar
          done
      
      - name: ðŸ“¦ Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar
          retention-days: 1
  
  deploy-to-minikube:
    name: Deploy to Minikube
    runs-on: ubuntu-latest
    needs: build-docker-images
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸš€ Start Minikube
        uses: medyagh/setup-minikube@latest
        with:
          cpus: 4
          memory: 8192
          kubernetes-version: v1.28.0
      
      - name: ðŸ“¥ Download Docker Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: docker-images
      
      - name: ðŸ“¦ Load Images to Minikube
        run: |
          for image in docker-images/*.tar; do
            echo "Loading $(basename $image)"
            minikube image load $image
          done
      
      - name: â˜¸ï¸ Apply Kubernetes Manifests
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/configmaps.yaml
          kubectl apply -f k8s/base/
          
          echo "Waiting for deployments to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment --all -n ecommerce || true
      
      - name: ðŸ“Š Check Deployment Status
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n ecommerce
          
          echo "=== Services ==="
          kubectl get svc -n ecommerce
      
      - name: ðŸ§ª Run E2E Tests with Newman
        continue-on-error: true
        run: |
          echo ""
          echo "========================================"
          echo " Running E2E Tests with Newman"
          echo "========================================"
          echo ""
          
          # Port-forward al API Gateway en background
          echo "Setting up port-forward to API Gateway..."
          kubectl port-forward -n ecommerce svc/api-gateway 8080:8080 &
          PORTFORWARD_PID=$!
          sleep 15
          
          echo "Checking if API Gateway is accessible..."
          
          # Verificar conectividad
          if curl -f http://localhost:8080/app/actuator/health --max-time 5 --silent > /dev/null; then
            echo "âœ… API Gateway is accessible at http://localhost:8080"
            echo ""
            
            # Verificar si Newman estÃ¡ instalado
            if command -v newman &> /dev/null; then
              echo "Running E2E tests with Newman..."
              cd tests/e2e
              
              newman run ecommerce-e2e-tests.postman_collection.json \
                --environment ecommerce-e2e-environment.postman_environment.json \
                --reporters cli,json \
                --reporter-json-export ../../newman-results.json \
                --timeout-request 10000 \
                --delay-request 500 || true
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "âœ… E2E tests passed successfully!"
              else
                echo ""
                echo "âš ï¸  Some E2E tests failed, check the report"
              fi
              
              cd ../..
            else
              echo "âš ï¸  Newman not installed, installing now..."
              npm install -g newman || echo "Failed to install Newman, skipping E2E tests"
              
              if command -v newman &> /dev/null; then
                cd tests/e2e
                newman run ecommerce-e2e-tests.postman_collection.json \
                  --environment ecommerce-e2e-environment.postman_environment.json \
                  --reporters cli,json \
                  --reporter-json-export ../../newman-results.json \
                  --timeout-request 10000 \
                  --delay-request 500 || true
                cd ../..
              fi
            fi
          else
            echo "âŒ API Gateway is not accessible at http://localhost:8080"
            echo ""
            echo "Running basic connectivity tests instead..."
            
            # Pruebas bÃ¡sicas como fallback
            kubectl port-forward -n ecommerce svc/product-service 8500:8500 &
            kubectl port-forward -n ecommerce svc/user-service 8700:8700 &
            sleep 10
            
            curl -f http://localhost:8500/product-service/api/products || echo "Product service test failed"
            curl -f http://localhost:8700/user-service/api/users || echo "User service test failed"
          fi
          
          # Cleanup port-forward
          kill $PORTFORWARD_PID 2>/dev/null || true
          echo ""
  
  summary:
    name: STAGE Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-images, deploy-to-minikube]
    if: always()
    
    steps:
      - name: ðŸ“‹ Create Summary
        run: |
          echo "## ðŸŽ¯ STAGE Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.build-docker-images.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Minikube Deploy: ${{ needs.deploy-to-minikube.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** STAGE" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

name: DEV - Tests & Deploy

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        service: [ 'user-service', 'product-service', 'order-service', 'payment-service', 'shipping-service', 'favourite-service' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Run unit tests for ${{ matrix.service }}
        run: |
          chmod +x ./mvnw || true
          ./mvnw -pl ${{ matrix.service }} -am test

      - name: Publish unit test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests - ${{ matrix.service }}
          path: ${{ matrix.service }}/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      fail-fast: true
      matrix:
        include:
          - module: user-service
            test: UserControllerIntegrationTest
          - module: payment-service
            test: PaymentServiceIntegrationTest
          - module: favourite-service
            test: FavouriteServiceIntegrationTest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Run integration test ${{ matrix.test }} in ${{ matrix.module }}
        run: |
          chmod +x ./mvnw || true
          echo "Running integration test '${{ matrix.test }}' in module '${{ matrix.module }}'"
          ./mvnw -pl ${{ matrix.module }} -am -Dtest=${{ matrix.test }} -DfailIfNoTests=false test

      - name: Publish integration test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Tests - ${{ matrix.module }}
          path: ${{ matrix.module }}/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

  deploy:
    name: Deploy to AKS dev
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/dev'
    environment: dev
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VERSION: '1.7.0'
      ENVIRONMENT: 'dev'
      AKS_NAME: ${{ secrets.AKS_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Get AKS credentials
        run: |
          if [ -z "${{ secrets.AKS_NAME }}" ]; then
            echo "ERROR: secret AKS_NAME is not set. Please add repository or environment secret 'AKS_NAME' with your AKS cluster name.";
            exit 1;
          fi
          az aks get-credentials --resource-group "${{ secrets.AKS_RG }}" --name "${{ secrets.AKS_NAME }}" --overwrite-existing

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Install Helm
        uses: azure/setup-helm@v1

      - name: Create namespace
        run: |
          kubectl create namespace ecommerce-dev || true

      - name: Create GHCR secret (if provided)
        run: |
          if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then \
            kubectl create secret docker-registry ghcr-secret --docker-server=ghcr.io --docker-username=${{ secrets.GHCR_USERNAME }} --docker-password=${{ secrets.GHCR_TOKEN }} --namespace=ecommerce-dev || true; \
          else \
            echo "GHCR_TOKEN not provided, skipping secret creation"; \
          fi

      - name: Deploy Helm chart
        working-directory: k8s/helm
        run: |
          helm upgrade --install ecommerce-app ./ecommerce-chart \
            --namespace ecommerce-dev \
            --values ./ecommerce-chart/values.yaml \
            --values ../image-tags-dev.yaml \
            --set global.environment=${{ env.ENVIRONMENT }} --wait --timeout 10m

      - name: Verify deployment
        run: |
          kubectl get pods -n ecommerce-dev
          kubectl get svc -n ecommerce-dev

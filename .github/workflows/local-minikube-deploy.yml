name: Local Minikube Deployment Pipeline

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test Services
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: ğŸ”¨ Build all services with Maven
      run: |
        echo "Building all microservices..."
        mvn clean package -DskipTests
        
    - name: ğŸ§ª Run Unit Tests
      run: |
        echo "Running unit tests..."
        mvn test
        
    - name: âœ… Tests completed
      run: |
        echo "âœ… All tests passed successfully!"
        
  deploy-to-minikube:
    name: Deploy to Local Minikube
    needs: build-and-test
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ”§ Setup kubectl
      run: |
        echo "Checking kubectl version..."
        kubectl version --client
        
    - name: ğŸ³ Build Docker images
      run: |
        echo "Building Docker images for Minikube..."
        eval $(minikube docker-env)
        docker build -t api-gateway:latest ./api-gateway
        docker build -t user-service:latest ./user-service
        docker build -t product-service:latest ./product-service
        docker build -t order-service:latest ./order-service
        docker build -t payment-service:latest ./payment-service
        docker build -t shipping-service:latest ./shipping-service
        docker build -t favourite-service:latest ./favourite-service
        docker build -t proxy-client:latest ./proxy-client
        echo "âœ… Docker images built successfully!"
        
    - name: ğŸš€ Deploy to Minikube
      run: |
        echo "Deploying to Minikube namespace 'ecommerce'..."
        kubectl apply -f k8s/base/namespace.yaml
        kubectl apply -f k8s/base/configmaps.yaml
        kubectl apply -f k8s/base/
        echo "Waiting for deployments to be ready..."
        kubectl wait --for=condition=ready pod -l app=api-gateway -n ecommerce --timeout=300s || true
        echo "âœ… Deployment completed!"
        
    - name: ğŸ” Verify Deployment
      run: |
        echo "Verifying deployment status..."
        kubectl get pods -n ecommerce
        kubectl get svc -n ecommerce
        
    - name: ğŸ‰ Success Message
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                                    â•‘"
        echo "â•‘   âœ… PIPELINE EJECUTADO EXITOSAMENTE âœ…           â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•‘   ğŸš€ Servicios desplegados en Minikube           â•‘"
        echo "â•‘   ğŸ“¦ Namespace: ecommerce                         â•‘"
        echo "â•‘   ğŸŒ API Gateway: http://localhost:8080/app       â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•‘   Para acceder ejecuta:                           â•‘"
        echo "â•‘   kubectl port-forward -n ecommerce               â•‘"
        echo "â•‘        svc/api-gateway 8080:8080                  â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
